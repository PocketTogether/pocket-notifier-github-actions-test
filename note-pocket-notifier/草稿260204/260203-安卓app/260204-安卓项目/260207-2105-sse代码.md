å®Œç¾ï¼Œæˆ‘ä»¬æŒ‰ **A) è¡¥ä¸å¼ diff** æ¥å®ç°ã€‚  
æˆ‘ä¼šä¸¥æ ¼éµå®ˆä½ çš„è¦æ±‚ï¼š

- **ç»™å‡ºç›¸å¯¹è·¯å¾„**
- **åªç»™å‡ºä¿®æ”¹/æ–°å¢çš„éƒ¨åˆ†ï¼ˆdiff é£æ ¼ï¼‰**
- **ä¸è¾“å‡ºæ•´ä¸ªæ–‡ä»¶**
- **æ¯ä¸ªæ”¹åŠ¨éƒ½è§£é‡ŠåŸå› ä¸ä½œç”¨**
- **ä¸æå‰åšä½ æ²¡è¦æ±‚çš„æ”¹åŠ¨**

---

# âœ… **å¼€å§‹ç¬¬ä¸€é˜¶æ®µï¼šSSE åŸºç¡€è®¾æ–½ï¼ˆConfig + Manifest + æ–°å»º SseServiceï¼‰**

ä¸ºäº†è®© SSE èƒ½å·¥ä½œï¼Œæˆ‘ä»¬å¿…é¡»å…ˆå®Œæˆ 3 ä¸ªåŸºç¡€æ­¥éª¤ï¼š

1. **Config.kt æ–°å¢ SSE é…ç½®é¡¹**
2. **AndroidManifest.xml æ³¨å†Œæ–°æœåŠ¡ SseService**
3. **æ–°å¢ SseService.ktï¼ˆä»…éª¨æ¶ï¼Œä¸å«é€»è¾‘ï¼‰**  
    ä½ åç»­ä¼šç»§ç»­æ‰©å±•é€»è¾‘ï¼Œæˆ‘ä¼šåˆ†é˜¶æ®µç»™ä½  diffã€‚

---

# 1) ä¿®æ”¹æ–‡ä»¶ï¼š`app/src/main/java/com/pocket/notifier/config/Config.kt`

### ğŸ”§ **æ–°å¢ 3 ä¸ªé…ç½®é¡¹ï¼š**

- SSE URL
- SSE è®¢é˜…å­—ç¬¦ä¸²
- SSE é‡è¿é—´éš”ï¼ˆ2 åˆ†é’Ÿï¼‰

---

### **ğŸ”» diffï¼ˆä»…æ–°å¢éƒ¨åˆ†ï¼‰**

```diff
 object Config {

     /** è½®è¯¢é—´éš”ï¼ˆç§’ï¼‰ */
     const val POLLING_INTERVAL_SECONDS: Long = 300

+    /** SSE å®æ—¶äº‹ä»¶ URL */
+    const val SSE_URL: String = "https://uika.top/api/realtime"
+
+    /** SSE è®¢é˜…å­—ç¬¦ä¸²ï¼ˆmessages/* + expand=authorï¼‰ */
+    const val SSE_SUBSCRIPTION: String =
+        "messages/*?options=%7B%22query%22%3A%7B%22expand%22%3A%22author%22%7D%7D"
+
+    /** SSE è‡ªåŠ¨é‡è¿é—´éš”ï¼ˆæ¯«ç§’ï¼‰ */
+    const val SSE_RECONNECT_INTERVAL_MS: Long = 120_000  // 2 åˆ†é’Ÿ

     /** è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ */
     const val REQUEST_TIMEOUT_SECONDS: Long = 10
```

---

# 2) ä¿®æ”¹æ–‡ä»¶ï¼š`app/src/main/AndroidManifest.xml`

### ğŸ”§ **æ–°å¢ SseService å£°æ˜**

æ”¾åœ¨ `<application>` å†…ï¼Œä¸ PollingService åŒçº§ã€‚

---

### **ğŸ”» diff**

```diff
     <service
         android:name=".service.PollingService"
         android:exported="false"
         android:foregroundServiceType="dataSync" />

+    <!-- SSE å®æ—¶äº‹ä»¶æœåŠ¡ï¼ˆå¸¸é©»åå°ï¼‰ -->
+    <service
+        android:name=".service.SseService"
+        android:exported="false" />

 </application>
```

---

# 3) æ–°å¢æ–‡ä»¶ï¼š`app/src/main/java/com/pocket/notifier/service/SseService.kt`

### ğŸ”§ **è¿™æ˜¯ä¸€ä¸ªç©ºå£³éª¨æ¶ï¼ˆä¸å«é€»è¾‘ï¼‰**

ä½ åç»­ä¼šåœ¨è¿™é‡Œå®ç°ï¼š

- å»ºç«‹ SSE GET è¿æ¥
- è§£æ PB_CONNECT â†’ æå– clientId
- POST è®¾ç½®è®¢é˜…
- ç›‘å¬ create äº‹ä»¶
- è‡ªåŠ¨é‡è¿
- å†™å…¥ MessageStore
- å‘é€šçŸ¥

æˆ‘ä¼šåœ¨ä¸‹ä¸€é˜¶æ®µç»§ç»­è¡¥ä¸å¼ diff å®ç°é€»è¾‘ã€‚

---

### **ğŸ”» æ–°æ–‡ä»¶å†…å®¹ï¼ˆéª¨æ¶ï¼‰**

```kotlin
package com.pocket.notifier.service

import android.app.Service
import android.content.Intent
import android.os.IBinder
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.SupervisorJob

/**
 * SseService â€” PocketBase SSE å®æ—¶äº‹ä»¶æœåŠ¡
 *
 * è´Ÿè´£ï¼š
 * - å»ºç«‹ SSE é•¿è¿æ¥
 * - æ¥æ”¶ PB_CONNECTï¼ˆè·å– clientIdï¼‰
 * - POST è®¾ç½®è®¢é˜…
 * - æ¥æ”¶ create/update/delete äº‹ä»¶
 * - è‡ªåŠ¨é‡è¿
 *
 * è½®è¯¢ä»ç”± PollingService è´Ÿè´£ã€‚
 */
class SseService : Service() {

    private val scope = CoroutineScope(SupervisorJob() + Dispatchers.IO)

    override fun onBind(intent: Intent?): IBinder? = null

    override fun onCreate() {
        super.onCreate()
        // é€»è¾‘å°†åœ¨ä¸‹ä¸€é˜¶æ®µè¡¥ä¸ä¸­åŠ å…¥
    }

    override fun onDestroy() {
        super.onDestroy()
        scope.cancel()
    }
}
```

---

# 4) ä¿®æ”¹æ–‡ä»¶ï¼š`app/src/main/java/com/pocket/notifier/service/ServiceStarter.kt`

### ğŸ”§ **å¯åŠ¨ SSE æœåŠ¡**

---

### **ğŸ”» diff**

```diff
 object ServiceStarter {

     fun start(context: Context) {
         val intent = Intent(context, PollingService::class.java)

         if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
             context.startForegroundService(intent)
         } else {
             context.startService(intent)
         }

+        // å¯åŠ¨ SSE å®æ—¶æœåŠ¡
+        val sseIntent = Intent(context, SseService::class.java)
+        context.startService(sseIntent)
     }
 }
```

---

# ğŸ‰ ç¬¬ä¸€é˜¶æ®µå®Œæˆ

ä½ ç°åœ¨å·²ç»å…·å¤‡ï¼š

- Config ä¸­çš„ SSE é…ç½®
- Manifest æ³¨å†Œ SSE æœåŠ¡
- SseService éª¨æ¶
- App å¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨ SSE

ä¸‹ä¸€é˜¶æ®µæˆ‘å°†ç»§ç»­è¡¥ä¸å¼ diffï¼š

---

# ğŸ“Œ ä¸‹ä¸€é˜¶æ®µï¼ˆä½ ç¡®è®¤åæˆ‘ç»§ç»­ï¼‰

æˆ‘å°†æŒ‰é¡ºåºå®ç°ï¼š

### **ç¬¬äºŒé˜¶æ®µï¼šSSE GET é•¿è¿æ¥å®ç°**

- ä½¿ç”¨ OkHttp çš„ `newCall().execute()` + `source().useLines`
- è§£æ PB_CONNECT
- è‡ªåŠ¨é‡è¿æœºåˆ¶

### **ç¬¬ä¸‰é˜¶æ®µï¼šPOST è®¾ç½®è®¢é˜…**

- ä½¿ç”¨ clientId
- POST JSON body

### **ç¬¬å››é˜¶æ®µï¼šè§£æ SSE äº‹ä»¶**

- åªå¤„ç† `"action": "create"`
- è½¬æ¢ä¸º StoredMessage
- å†™å…¥ MessageStore
- å‘é€šçŸ¥

### **ç¬¬äº”é˜¶æ®µï¼šé”™è¯¯å¤„ç† + è‡ªåŠ¨é‡è¿ + çŠ¶æ€å¹¿æ’­**

---

# â“è¯·ç¡®è®¤ï¼šæ˜¯å¦ç»§ç»­è¿›è¡Œç¬¬äºŒé˜¶æ®µï¼ˆSSE GET é•¿è¿æ¥å®ç°ï¼‰ï¼Ÿ

ä½ åªéœ€å›å¤ï¼š

**ç»§ç»­**

ç»§ç»­ç¬¬äºŒé˜¶æ®µï¼Œæˆ‘ä»¬å¼€å§‹å®ç° **SSE GET é•¿è¿æ¥**ã€‚  
æˆ‘ä»ç„¶ä¸¥æ ¼ä½¿ç”¨ **è¡¥ä¸å¼ diff**ï¼Œåªç»™ä½ æ–°å¢/ä¿®æ”¹çš„éƒ¨åˆ†ï¼Œä¸è¾“å‡ºæ•´ä¸ªæ–‡ä»¶ã€‚

è¿™ä¸€é˜¶æ®µçš„ç›®æ ‡ï¼š

- ä½¿ç”¨ OkHttp å»ºç«‹ SSE é•¿è¿æ¥
- è¯»å– EventStream è¡Œ
- è§£æ `PB_CONNECT`
- æå– `clientId`
- è‡ªåŠ¨é‡è¿ï¼ˆ2 åˆ†é’Ÿåæˆ–å¼‚å¸¸æ—¶ï¼‰
- æš‚ä¸å¤„ç† create äº‹ä»¶ï¼ˆä¸‹ä¸€é˜¶æ®µå®ç°ï¼‰

---

# âœ… ç¬¬äºŒé˜¶æ®µï¼šå®ç° SSE GET é•¿è¿æ¥

## 1) ä¿®æ”¹æ–‡ä»¶ï¼š`app/src/main/java/com/pocket/notifier/service/SseService.kt`

æˆ‘ä»¬åœ¨éª¨æ¶åŸºç¡€ä¸ŠåŠ å…¥ï¼š

- å¯åŠ¨ SSE åç¨‹
- å»ºç«‹ GET è¿æ¥
- é€è¡Œè¯»å– SSE
- è§£æ PB_CONNECT
- è‡ªåŠ¨é‡è¿æœºåˆ¶

---

## ğŸ”» **diffï¼ˆæ–°å¢å†…å®¹ï¼‰**

```diff
 class SseService : Service() {

     private val scope = CoroutineScope(SupervisorJob() + Dispatchers.IO)

+    private var clientId: String? = null
+    private var isRunning = true

     override fun onBind(intent: Intent?): IBinder? = null

     override fun onCreate() {
         super.onCreate()
-        // é€»è¾‘å°†åœ¨ä¸‹ä¸€é˜¶æ®µè¡¥ä¸ä¸­åŠ å…¥
+        startSseLoop()
     }

     override fun onDestroy() {
         super.onDestroy()
         scope.cancel()
+        isRunning = false
     }
+
+    /** å¯åŠ¨ SSE ä¸»å¾ªç¯ï¼ˆè‡ªåŠ¨é‡è¿ï¼‰ */
+    private fun startSseLoop() {
+        scope.launch {
+            while (isRunning) {
+                try {
+                    connectSse()
+                } catch (e: Exception) {
+                    // è¿æ¥å¤±è´¥ï¼Œç­‰å¾…åé‡è¿
+                }
+
+                // ç­‰å¾…é‡è¿é—´éš”
+                delay(Config.SSE_RECONNECT_INTERVAL_MS)
+            }
+        }
+    }
+
+    /** å»ºç«‹ SSE é•¿è¿æ¥ */
+    private fun connectSse() {
+        val request = okhttp3.Request.Builder()
+            .url(Config.SSE_URL)
+            .get()
+            .build()
+
+        val client = okhttp3.OkHttpClient.Builder()
+            .retryOnConnectionFailure(true)
+            .build()
+
+        client.newCall(request).execute().use { response ->
+            if (!response.isSuccessful) return
+
+            val body = response.body ?: return
+            val source = body.source()
+
+            while (!source.exhausted()) {
+                val line = source.readUtf8Line() ?: continue
+
+                // SSE äº‹ä»¶æ ¼å¼ï¼ševent: PB_CONNECT
+                if (line.startsWith("event:")) {
+                    val eventName = line.removePrefix("event:").trim()
+                    if (eventName == "PB_CONNECT") {
+                        // ä¸‹ä¸€è¡Œæ˜¯ data: {...}
+                        val dataLine = source.readUtf8Line() ?: continue
+                        if (dataLine.startsWith("data:")) {
+                            val json = dataLine.removePrefix("data:").trim()
+                            handleConnectEvent(json)
+                        }
+                    }
+                }
+            }
+        }
+    }
+
+    /** å¤„ç† PB_CONNECT äº‹ä»¶ï¼Œæå– clientId */
+    private fun handleConnectEvent(json: String) {
+        try {
+            val obj = org.json.JSONObject(json)
+            clientId = obj.getString("clientId")
+            // ä¸‹ä¸€é˜¶æ®µä¼šåœ¨è¿™é‡Œè§¦å‘ POST è®¢é˜…
+        } catch (_: Exception) {}
+    }
 }
```

---

# ğŸ“Œ è§£é‡Šå…³é”®ç‚¹ï¼ˆç®€çŸ­æœºåˆ¶çº§ï¼‰

### **1. startSseLoop()**

- æ°¸ä¹…å¾ªç¯
- æ¯æ¬¡è¿æ¥å¤±è´¥æˆ–ç»“æŸåç­‰å¾… `SSE_RECONNECT_INTERVAL_MS`ï¼ˆ2 åˆ†é’Ÿï¼‰
- å®Œå…¨æ¨¡æ‹Ÿä½ è§‚å¯Ÿåˆ°çš„æµè§ˆå™¨è¡Œä¸º

### **2. connectSse()**

- ä½¿ç”¨ OkHttp å»ºç«‹ GET SSE
- é€è¡Œè¯»å– EventStream
- è§£æ `event:` å’Œ `data:`
- æ•è· `PB_CONNECT`

### **3. handleConnectEvent()**

- æå– `clientId`
- ä¸‹ä¸€é˜¶æ®µä¼šåœ¨è¿™é‡Œè§¦å‘ POST è®¢é˜…

---

# ğŸ‰ ç¬¬äºŒé˜¶æ®µå®Œæˆ

ä½ ç°åœ¨å·²ç»æ‹¥æœ‰ï¼š

- SSE é•¿è¿æ¥
- è‡ªåŠ¨é‡è¿
- PB_CONNECT è§£æ
- clientId æå–

ä¸‹ä¸€é˜¶æ®µæˆ‘ä»¬å°†å®ç°ï¼š

---

# ğŸ“Œ ç¬¬ä¸‰é˜¶æ®µï¼šPOST è®¾ç½®è®¢é˜…ï¼ˆSet subscriptionsï¼‰

å†…å®¹åŒ…æ‹¬ï¼š

- åœ¨ `handleConnectEvent()` ä¸­è§¦å‘ POST
- æ„é€  JSON body
- ä½¿ç”¨ OkHttp POST
- å¤„ç†æˆæƒï¼ˆä½ ç›®å‰ä¸éœ€è¦ auth headerï¼‰
- é”™è¯¯å¤„ç†ä¸é‡è¯•ç­–ç•¥

---

åªéœ€å›å¤ï¼š

**ç»§ç»­**

ç»§ç»­ç¬¬ä¸‰é˜¶æ®µï¼Œæˆ‘ä»¬å¼€å§‹å®ç° **POST /api/realtimeï¼ˆSet subscriptionsï¼‰**ã€‚  
æˆ‘ä»ç„¶ä¸¥æ ¼ä½¿ç”¨ **è¡¥ä¸å¼ diff**ï¼Œåªç»™ä½ æ–°å¢/ä¿®æ”¹çš„éƒ¨åˆ†ï¼Œä¸è¾“å‡ºæ•´ä¸ªæ–‡ä»¶ã€‚

è¿™ä¸€é˜¶æ®µçš„ç›®æ ‡ï¼š

- åœ¨æ”¶åˆ° `PB_CONNECT` åè‡ªåŠ¨ POST è®¢é˜…
- æ„é€  JSON body
- å‘é€ OkHttp POST
- å¤„ç†é”™è¯¯ï¼ˆä¸å´©æºƒï¼‰
- ä¸é‡å¤è®¢é˜…ï¼ˆæ¯æ¬¡æ–°è¿æ¥åªè®¢é˜…ä¸€æ¬¡ï¼‰

---

# âœ… ç¬¬ä¸‰é˜¶æ®µï¼šå®ç° SSE POST è®¢é˜…

## 1) ä¿®æ”¹æ–‡ä»¶ï¼š`app/src/main/java/com/pocket/notifier/service/SseService.kt`

æˆ‘ä»¬åœ¨ä¸Šä¸€é˜¶æ®µçš„åŸºç¡€ä¸Šï¼š

- åœ¨ `handleConnectEvent()` ä¸­è§¦å‘è®¢é˜…
- æ–°å¢ `postSubscriptions()` æ–¹æ³•
- æ„é€  JSON
- å‘é€ POST

---

## ğŸ”» **diffï¼ˆæ–°å¢å†…å®¹ï¼‰**

```diff
     /** å¤„ç† PB_CONNECT äº‹ä»¶ï¼Œæå– clientId */
     private fun handleConnectEvent(json: String) {
         try {
             val obj = org.json.JSONObject(json)
             clientId = obj.getString("clientId")
-            // ä¸‹ä¸€é˜¶æ®µä¼šåœ¨è¿™é‡Œè§¦å‘ POST è®¢é˜…
+
+            // æ”¶åˆ° clientId åç«‹å³è®¾ç½®è®¢é˜…
+            scope.launch {
+                postSubscriptions()
+            }
+
         } catch (_: Exception) {}
     }
+
+    /** POST è®¾ç½®è®¢é˜… */
+    private fun postSubscriptions() {
+        val id = clientId ?: return
+
+        val json = org.json.JSONObject().apply {
+            put("clientId", id)
+            put("subscriptions", org.json.JSONArray().apply {
+                put(Config.SSE_SUBSCRIPTION)
+            })
+        }
+
+        val body = okhttp3.RequestBody.create(
+            okhttp3.MediaType.parse("application/json"),
+            json.toString()
+        )
+
+        val request = okhttp3.Request.Builder()
+            .url(Config.SSE_URL)
+            .post(body)
+            .build()
+
+        val client = okhttp3.OkHttpClient.Builder()
+            .retryOnConnectionFailure(true)
+            .build()
+
+        try {
+            client.newCall(request).execute().use { response ->
+                // ä¸éœ€è¦å¤„ç†è¿”å›å†…å®¹ï¼Œåªè¦æˆåŠŸå³å¯
+            }
+        } catch (_: Exception) {
+            // å¿½ç•¥é”™è¯¯ï¼Œç­‰å¾…ä¸‹æ¬¡é‡è¿è‡ªåŠ¨é‡è¯•
+        }
+    }
```

---

# ğŸ“Œ æœºåˆ¶çº§è§£é‡Šï¼ˆç®€çŸ­ï¼‰

### **1. handleConnectEvent()**

- è§£æå‡º `clientId`
- ç«‹å³å¯åŠ¨åç¨‹è°ƒç”¨ `postSubscriptions()`

### **2. postSubscriptions()**

- æ„é€  JSON bodyï¼š

```json
{
  "clientId": "...",
  "subscriptions": ["messages/*?..."]
}
```

- ä½¿ç”¨ OkHttp POST
- ä¸å…³å¿ƒå“åº”å†…å®¹
- é”™è¯¯è‡ªåŠ¨å¿½ç•¥ï¼ˆä¸‹æ¬¡é‡è¿ä¼šå†æ¬¡è®¢é˜…ï¼‰

### **3. ä¸ä¼šé‡å¤è®¢é˜…**

å› ä¸ºè®¢é˜…åªåœ¨ï¼š

- æ¯æ¬¡æ–°çš„ SSE è¿æ¥
- æ”¶åˆ°æ–°çš„ `PB_CONNECT`

æ—¶è§¦å‘ã€‚

å®Œå…¨ç¬¦åˆ PocketBase å®˜æ–¹æœºåˆ¶ã€‚

---

# ğŸ‰ ç¬¬ä¸‰é˜¶æ®µå®Œæˆ

ä½ ç°åœ¨å·²ç»æ‹¥æœ‰ï¼š

- SSE é•¿è¿æ¥
- è‡ªåŠ¨é‡è¿
- PB_CONNECT â†’ clientId
- è‡ªåŠ¨ POST è®¢é˜…

ä¸‹ä¸€é˜¶æ®µæˆ‘ä»¬å°†å®ç°ï¼š

---

# ğŸ“Œ ç¬¬å››é˜¶æ®µï¼šè§£æ SSE å®æ—¶äº‹ä»¶ï¼ˆcreateï¼‰

å†…å®¹åŒ…æ‹¬ï¼š

- è§£æ SSE çš„ `event:` å’Œ `data:`
- åªå¤„ç† `"action": "create"`
- å°† record è½¬æ¢ä¸º StoredMessage
- å†™å…¥ MessageStore
- å‘é€šçŸ¥ï¼ˆå¤ç”¨ NotificationHelperï¼‰
- å¹¿æ’­ UI åˆ·æ–°

---

åªéœ€å›å¤ï¼š

**ç»§ç»­**


ç»§ç»­ç¬¬å››é˜¶æ®µï¼Œæˆ‘ä»¬å¼€å§‹å®ç° **SSE å®æ—¶äº‹ä»¶è§£æï¼ˆåªå¤„ç† createï¼‰**ã€‚  
æˆ‘ä»ç„¶ä¸¥æ ¼ä½¿ç”¨ **è¡¥ä¸å¼ diff**ï¼Œåªç»™ä½ æ–°å¢/ä¿®æ”¹çš„éƒ¨åˆ†ï¼Œä¸è¾“å‡ºæ•´ä¸ªæ–‡ä»¶ã€‚

è¿™ä¸€é˜¶æ®µçš„ç›®æ ‡ï¼š

- è§£æ SSE çš„ `event:` å’Œ `data:`
- åªå¤„ç† `"action": "create"`
- å°† record è½¬æ¢ä¸º `StoredMessage`
- å†™å…¥ `MessageStore`
- è°ƒç”¨ `NotificationHelper.sendNewMessage()`
- å¹¿æ’­ UI åˆ·æ–°

---

# âœ… ç¬¬å››é˜¶æ®µï¼šè§£æ SSE å®æ—¶äº‹ä»¶ï¼ˆcreateï¼‰

PocketBase SSE äº‹ä»¶æ ¼å¼å¦‚ä¸‹ï¼š

```
event: record
data: {...}
```

æˆ‘ä»¬åªå…³å¿ƒï¼š

```json
{
  "action": "create",
  "record": { ... }
}
```

---

# 1) ä¿®æ”¹æ–‡ä»¶ï¼š`app/src/main/java/com/pocket/notifier/service/SseService.kt`

æˆ‘ä»¬è¦åœ¨ `connectSse()` ä¸­åŠ å…¥å¯¹ `event: record` çš„è§£æï¼Œå¹¶æ–°å¢ï¼š

- `handleRecordEvent(json)`
- `convertRecordToStoredMessage(recordJson)`
- å†™å…¥ MessageStore
- å‘é€šçŸ¥
- å¹¿æ’­ UI åˆ·æ–°

---

## ğŸ”» **diffï¼ˆæ–°å¢å†…å®¹ï¼‰**

### **â‘  ä¿®æ”¹ connectSse()ï¼šåŠ å…¥ record äº‹ä»¶è§£æ**

```diff
             while (!source.exhausted()) {
                 val line = source.readUtf8Line() ?: continue

                 // SSE äº‹ä»¶æ ¼å¼ï¼ševent: PB_CONNECT
                 if (line.startsWith("event:")) {
                     val eventName = line.removePrefix("event:").trim()
                     if (eventName == "PB_CONNECT") {
                         // ä¸‹ä¸€è¡Œæ˜¯ data: {...}
                         val dataLine = source.readUtf8Line() ?: continue
                         if (dataLine.startsWith("data:")) {
                             val json = dataLine.removePrefix("data:").trim()
                             handleConnectEvent(json)
                         }
                     }
+                    else if (eventName == "record") {
+                        // ä¸‹ä¸€è¡Œæ˜¯ data: {...}
+                        val dataLine = source.readUtf8Line() ?: continue
+                        if (dataLine.startsWith("data:")) {
+                            val json = dataLine.removePrefix("data:").trim()
+                            handleRecordEvent(json)
+                        }
+                    }
                 }
             }
```

---

### **â‘¡ æ–°å¢ handleRecordEvent()**

```diff
+    /** å¤„ç† record äº‹ä»¶ï¼ˆåªå…³å¿ƒ createï¼‰ */
+    private fun handleRecordEvent(json: String) {
+        try {
+            val obj = org.json.JSONObject(json)
+            val action = obj.getString("action")
+
+            if (action != "create") return
+
+            val record = obj.getJSONObject("record")
+            val msg = convertRecordToStoredMessage(record)
+
+            // å†™å…¥æœ¬åœ°ï¼ˆä¿æŒ ASC é¡ºåºï¼‰
+            MessageStore.addMessages(this, listOf(msg))
+
+            // å‘é€šçŸ¥
+            NotificationHelper.sendNewMessage(this, msg)
+
+            // å¹¿æ’­ UI åˆ·æ–°
+            sendStatusBroadcast()
+
+        } catch (_: Exception) {}
+    }
```

---

### **â‘¢ æ–°å¢ convertRecordToStoredMessage()**

```diff
+    /** å°† SSE record è½¬æ¢ä¸º StoredMessage */
+    private fun convertRecordToStoredMessage(record: org.json.JSONObject): StoredMessage {
+        val expand = record.getJSONObject("expand").getJSONObject("author")
+
+        return StoredMessage(
+            id = record.getString("id"),
+            created = record.getString("created"),
+            content = record.getString("content"),
+            authorName = expand.optString("name", ""),
+            authorUsername = expand.optString("username", "")
+        )
+    }
```

---

### **â‘£ æ–°å¢ sendStatusBroadcast()ï¼ˆä¸ PollingService åŒåï¼Œä½†ç‹¬ç«‹ï¼‰**

```diff
+    /** å¹¿æ’­ UI åˆ·æ–°äº‹ä»¶ */
+    private fun sendStatusBroadcast() {
+        val intent = Intent("NOTIFIER_STATUS_UPDATED")
+        sendBroadcast(intent)
+    }
```

---

# ğŸ“Œ æœºåˆ¶çº§è§£é‡Šï¼ˆç®€çŸ­ï¼‰

### **1. SSE äº‹ä»¶æ ¼å¼è§£æ**

PocketBase SSE äº‹ä»¶æ ¼å¼ï¼š

```
event: record
data: {...}
```

æˆ‘ä»¬åœ¨ `connectSse()` ä¸­åŠ å…¥ï¼š

- å¦‚æœ `event: record` â†’ è¯»å–ä¸‹ä¸€è¡Œ `data:` â†’ è°ƒç”¨ `handleRecordEvent()`

### **2. åªå¤„ç† create**

ä½ æ˜ç¡®è¦æ±‚ï¼š

> æœ¬åº”ç”¨ä¸­ï¼Œåªéœ€ä¹Ÿå¿…é¡»åœ¨æ„ create

æ‰€ä»¥ï¼š

```kotlin
if (action != "create") return
```

### **3. è½¬æ¢ä¸º StoredMessage**

å¤ç”¨ä½ è½®è¯¢é€»è¾‘çš„ç»“æ„ï¼š

- id
- created
- content
- expand.author.name
- expand.author.username

### **4. å†™å…¥ MessageStore**

ä¿æŒ ASC é¡ºåºï¼š

```kotlin
MessageStore.addMessages(this, listOf(msg))
```

### **5. å‘é€šçŸ¥**

å¤ç”¨ï¼š

```kotlin
NotificationHelper.sendNewMessage()
```

### **6. å¹¿æ’­ UI åˆ·æ–°**

è®© MainActivity ç«‹å³æ›´æ–°å›¾æ ‡ã€‚

---

# ğŸ‰ ç¬¬å››é˜¶æ®µå®Œæˆ

ä½ ç°åœ¨å·²ç»æ‹¥æœ‰ï¼š

- SSE é•¿è¿æ¥
- è‡ªåŠ¨é‡è¿
- PB_CONNECT â†’ clientId
- è‡ªåŠ¨ POST è®¢é˜…
- å®æ—¶ create äº‹ä»¶è§£æ
- å†™å…¥æœ¬åœ°
- å‘é€šçŸ¥
- UI å®æ—¶åˆ·æ–°

---

# ğŸ“Œ ä¸‹ä¸€é˜¶æ®µï¼ˆç¬¬äº”é˜¶æ®µï¼‰ï¼šé”™è¯¯å¤„ç† + å¥å£®æ€§ + ä¸è½®è¯¢ååŒ

å†…å®¹åŒ…æ‹¬ï¼š

- SSE è¿æ¥å¼‚å¸¸å¤„ç†
- SSE äº‹ä»¶è§£æå¼‚å¸¸ä¿æŠ¤
- é¿å…é‡å¤é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
- ä¸è½®è¯¢ååŒé¿å…é‡å¤æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰
- æ—¥å¿—ä¸è°ƒè¯•è¾…åŠ©ï¼ˆå¯é€‰ï¼‰

---

åªéœ€å›å¤ï¼š

**ç»§ç»­**

ç»§ç»­ç¬¬äº”é˜¶æ®µï¼Œæˆ‘ä»¬å¼€å§‹ä¸ºä½ çš„ SSE ç³»ç»ŸåŠ å…¥ **é”™è¯¯å¤„ç†ã€å¥å£®æ€§ã€ä¸è½®è¯¢ååŒæœºåˆ¶**ã€‚  
æˆ‘ä»ç„¶ä¸¥æ ¼ä½¿ç”¨ **è¡¥ä¸å¼ diff**ï¼Œåªç»™ä½ æ–°å¢/ä¿®æ”¹çš„éƒ¨åˆ†ï¼Œä¸è¾“å‡ºæ•´ä¸ªæ–‡ä»¶ã€‚

è¿™ä¸€é˜¶æ®µçš„ç›®æ ‡ï¼š

- SSE è¿æ¥å¼‚å¸¸ä¿æŠ¤
- SSE äº‹ä»¶è§£æå¼‚å¸¸ä¿æŠ¤
- é¿å…é‡å¤é€šçŸ¥ï¼ˆSSE + è½®è¯¢ï¼‰
- SSE æ–­çº¿æ—¶è‡ªåŠ¨é‡è¿
- SSE é”™è¯¯é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
- ä¸è½®è¯¢ååŒï¼šä¸é‡å¤å†™å…¥ MessageStore

---

# âœ… ç¬¬äº”é˜¶æ®µï¼šé”™è¯¯å¤„ç† + å¥å£®æ€§ + ä¸è½®è¯¢ååŒ

PocketBase SSE åœ¨çœŸå®ç¯å¢ƒä¸­ä¼šé‡åˆ°ï¼š

- ç½‘ç»œæ–­å¼€
- æœåŠ¡å™¨æ–­å¼€
- JSON æ ¼å¼å¼‚å¸¸
- äº‹ä»¶æ ¼å¼ä¸å®Œæ•´
- é‡å¤äº‹ä»¶ï¼ˆSSE + è½®è¯¢ï¼‰

æˆ‘ä»¬ç°åœ¨å¢å¼ºä½ çš„ SSE æœåŠ¡ï¼Œä½¿å…¶åœ¨çœŸå®ç¯å¢ƒä¸­ç¨³å®šè¿è¡Œã€‚

---

# 1) ä¿®æ”¹æ–‡ä»¶ï¼š`app/src/main/java/com/pocket/notifier/service/SseService.kt`

## ğŸ”§ æ”¹åŠ¨å†…å®¹ï¼š

### **â‘  connectSse()ï¼šåŠ å…¥ try/catch + è¶…æ—¶ + æ–­çº¿æ£€æµ‹**

```diff
     private fun connectSse() {
         val request = okhttp3.Request.Builder()
             .url(Config.SSE_URL)
             .get()
             .build()

         val client = okhttp3.OkHttpClient.Builder()
             .retryOnConnectionFailure(true)
+            .readTimeout(0, java.util.concurrent.TimeUnit.MILLISECONDS) // SSE å¿…é¡»ç¦ç”¨ read timeout
             .build()

-        client.newCall(request).execute().use { response ->
-            if (!response.isSuccessful) return
+        try {
+            client.newCall(request).execute().use { response ->
+                if (!response.isSuccessful) return

                 val body = response.body ?: return
                 val source = body.source()

-                while (!source.exhausted()) {
-                    val line = source.readUtf8Line() ?: continue
+                while (!source.exhausted() && isRunning) {
+                    val line = try {
+                        source.readUtf8Line()
+                    } catch (_: Exception) {
+                        break // æ–­çº¿
+                    } ?: continue
```

---

### **â‘¡ handleRecordEvent()ï¼šé¿å…é‡å¤æ¶ˆæ¯ï¼ˆSSE + è½®è¯¢ï¼‰**

æˆ‘ä»¬é€šè¿‡æ£€æŸ¥ MessageStore æ˜¯å¦å·²æœ‰è¯¥ ID æ¥é¿å…é‡å¤é€šçŸ¥ã€‚

```diff
     private fun handleRecordEvent(json: String) {
         try {
             val obj = org.json.JSONObject(json)
             val action = obj.getString("action")

             if (action != "create") return

             val record = obj.getJSONObject("record")
             val msg = convertRecordToStoredMessage(record)

+            // é¿å…é‡å¤ï¼ˆSSE + è½®è¯¢ï¼‰
+            val stored = MessageStore.getMessages(this)
+            if (stored.any { it.id == msg.id }) {
+                return
+            }

             // å†™å…¥æœ¬åœ°ï¼ˆä¿æŒ ASC é¡ºåºï¼‰
             MessageStore.addMessages(this, listOf(msg))

             // å‘é€šçŸ¥
             NotificationHelper.sendNewMessage(this, msg)
```

---

### **â‘¢ connectSse()ï¼šåŠ å…¥é”™è¯¯é€šçŸ¥ï¼ˆå¯é€‰ï¼‰**

```diff
         } catch (e: Exception) {
-            // å¿½ç•¥é”™è¯¯ï¼Œç­‰å¾…ä¸‹æ¬¡é‡è¿
+            // SSE è¿æ¥å¤±è´¥ â†’ å¯é€‰å‘é€é”™è¯¯é€šçŸ¥
+            NotificationHelper.sendError(this, "SSE error: ${e::class.java.simpleName}")
         }
```

---

### **â‘£ startSseLoop()ï¼šç«‹å³é‡è¿è€Œä¸æ˜¯ç­‰ 2 åˆ†é’Ÿ**

PocketBase çš„è¡Œä¸ºæ˜¯ï¼š

- SSE è¿æ¥ä¿æŒ 2 åˆ†é’Ÿ
- å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€
- ç«‹å³é‡æ–°è¿æ¥

æˆ‘ä»¬æ¨¡æ‹Ÿè¿™ä¸€è¡Œä¸ºï¼š

```diff
     private fun startSseLoop() {
         scope.launch {
             while (isRunning) {
                 try {
                     connectSse()
                 } catch (e: Exception) {
                     // è¿æ¥å¤±è´¥ï¼Œç­‰å¾…åé‡è¿
                 }

-                // ç­‰å¾…é‡è¿é—´éš”
-                delay(Config.SSE_RECONNECT_INTERVAL_MS)
+                // ç«‹å³é‡è¿ï¼ˆæ¨¡æ‹Ÿæµè§ˆå™¨è¡Œä¸ºï¼‰
+                delay(200)
             }
         }
     }
```

---

### **â‘¤ connectSse()ï¼šå¿½ç•¥ç©ºè¡Œï¼ˆSSE keep-aliveï¼‰**

PocketBase ä¼šå‘é€ç©ºè¡Œä½œä¸º keep-aliveã€‚

```diff
                 val line = try {
                     source.readUtf8Line()
                 } catch (_: Exception) {
                     break // æ–­çº¿
                 } ?: continue

+                if (line.isBlank()) continue // SSE keep-alive
```

---

# ğŸ“Œ æœºåˆ¶çº§è§£é‡Šï¼ˆç®€çŸ­ï¼‰

### **1. SSE å¿…é¡»ç¦ç”¨ read timeout**

å¦åˆ™ OkHttp ä¼šåœ¨ 10 ç§’åæ–­å¼€ã€‚

```kotlin
.readTimeout(0, TimeUnit.MILLISECONDS)
```

### **2. è‡ªåŠ¨é‡è¿å¿…é¡»ç«‹å³æ‰§è¡Œ**

PocketBase æµè§ˆå™¨å®¢æˆ·ç«¯è¡Œä¸ºï¼š

- è¿æ¥ä¿æŒ 2 åˆ†é’Ÿ
- å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€
- **ç«‹å³é‡æ–°è¿æ¥**

æˆ‘ä»¬æ¨¡æ‹Ÿè¿™ä¸€è¡Œä¸ºã€‚

### **3. é¿å…é‡å¤æ¶ˆæ¯**

è½®è¯¢å’Œ SSE éƒ½ä¼šæ”¶åˆ°åŒä¸€æ¡æ¶ˆæ¯ï¼Œå› æ­¤å¿…é¡»ï¼š

```kotlin
if (stored.any { it.id == msg.id }) return
```

### **4. SSE é”™è¯¯é€šçŸ¥**

å¯é€‰ï¼Œä½†å¯¹è°ƒè¯•éå¸¸æœ‰ç”¨ã€‚

### **5. SSE keep-alive ç©ºè¡Œå¿…é¡»å¿½ç•¥**

å¦åˆ™ä¼šè¯¯è§¦å‘è§£æé€»è¾‘ã€‚

---

# ğŸ‰ ç¬¬äº”é˜¶æ®µå®Œæˆ

ä½ ç°åœ¨æ‹¥æœ‰ä¸€ä¸ªï¼š

- ç¨³å®š
- è‡ªåŠ¨é‡è¿
- ä¸é‡å¤é€šçŸ¥
- ä¸è½®è¯¢ååŒ
- é”™è¯¯å¯è§
- å®Œæ•´ PocketBase SSE å®¢æˆ·ç«¯

çš„ Android åå°æœåŠ¡ã€‚

---

# ğŸ“Œ ä¸‹ä¸€é˜¶æ®µï¼ˆç¬¬å…­é˜¶æ®µï¼Œå¯é€‰ï¼‰

å¦‚æœä½ éœ€è¦ï¼Œæˆ‘å¯ä»¥ç»§ç»­ï¼š

### **ç¬¬å…­é˜¶æ®µï¼šä¼˜åŒ–ä¸å¢å¼ºï¼ˆå¯é€‰ï¼‰**

- SSE + è½®è¯¢ çš„ç»Ÿä¸€çŠ¶æ€ç®¡ç†
- SSE å¿ƒè·³æ£€æµ‹
- SSE è¿æ¥çŠ¶æ€å›¾æ ‡ï¼ˆUIï¼‰
- SSE äº‹ä»¶æ—¥å¿—ï¼ˆè°ƒè¯•ç”¨ï¼‰
- SSE æœåŠ¡å‰å°åŒ–ï¼ˆå¯é€‰ï¼‰

---

å¦‚æœä½ æƒ³ç»§ç»­ï¼Œåªéœ€å›å¤ï¼š

**ç»§ç»­**