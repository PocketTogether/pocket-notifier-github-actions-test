```
è¿™æ˜¯æˆ‘ç°åœ¨çš„é¡¹ç›®ï¼ˆå¦‚ä¸Šä¼ çš„æ–‡ä»¶æ‰€ç¤ºï¼‰
ä½ å…ˆäº†è§£æˆ‘çš„é¡¹ç›®å’Œéœ€æ±‚ï¼Œå…ˆä¸å¿…å®ç°
ä¸å¿…å›å¤

æ³¨æ„ï¼Œç°åœ¨è¿˜æ˜¯ä¸»è¦é€šè¿‡è½®è¯¢æ¥è·å–æ•°æ®ï¼Œæ–°å¢äº†æ•°æ®å¤„ç†ç½¢äº†
ç°åœ¨æˆ‘æƒ³å®ç°ï¼Œæ–°å¢sseå®æ—¶æ¶ˆæ¯çš„æ”¯æŒ
æˆ‘æ¥è®²è®²ï¼Œæ€»å…±æœ‰ä¸‰ç§è¯·æ±‚
- pbçš„sseçš„å®æ—¶äº‹ä»¶ï¼Œå®æ—¶è·å–æ¶ˆæ¯ Connect
  - GET https://uika.top/api/realtime
- pbå®æ—¶è®¢é˜…è®¾ç½®è¯·æ±‚ Set subscriptions
  - POST https://uika.top/api/realtime
- è½®è¯¢æ•°æ®è¯·æ±‚ï¼Œè¿™ä¸ªå’ŒåŸæ¥ä¸€æ ·ï¼Œä½†åœ¨è¿™é‡Œä»ä¿ç•™ï¼Œç”¨äºé¿å…æ¼æ¶ˆæ¯ 
  - GET https://uika.top/api/collections/messages/records?page=1&perPage=40&expand=author&sort=-created%2Cid&skipTotal=true

https://uika.top/api/realtime
æ­¤å­—ç¬¦ä¸²å»ºè®®é…ç½®åˆ° Config.kt

pbå®æ—¶è®¢é˜…å®˜æ–¹æ–‡æ¡£https://pocketbase.io/docs/api-realtime/
The Realtime API is implemented via Server-Sent Events (SSE). Generally, it consists of 2 operations:
1. establish SSE connection
2. submit client subscriptions
SSE events are sent for **create**, **update** and **delete** record operations.

Connect **GET**
/api/realtime
Establishes a new SSE connection and immediately sends a `PB_CONNECT` SSE event with the created client ID.
**NB!** The user/superuser authorization happens during the first [Set subscriptions](https://pocketbase.io/docs/api-realtime#set-subscriptions) call.
If the connected client doesn't receive any new messages for 5 minutes, the server will send a disconnect signal (this is to prevent forgotten/leaked connections). The connection will be automatically reestablished if the client is still active (e.g. the browser tab is still open).

Set subscriptions **POST**
/api/realtime
Sets new active client's subscriptions (and auto unsubscribes from the previous ones).
If `Authorization` header is set, will authorize the client SSE connection with the associated user or superuser.
Body Parameters
|   |   |   |
|---|---|---|
|Required clientId|String|ID of the SSE client connection.|
|Optional subscriptions|Array<String>|The new client subscriptions to set in the format:  <br>`COLLECTION_ID_OR_NAME/*` or `COLLECTION_ID_OR_NAME/RECORD_ID`.<br><br>You can also attach optional query and header parameters as serialized json to a single topic using the `options` query parameter, e.g.:<br><br>`COLLECTION_ID_OR_NAME/RECORD_ID?options={"query": {"abc": "123"}, "headers": {"x-token": "..."}}`<br><br>Leave empty to unsubscribe from everything.|

Set subscriptions **POST**è¯·æ±‚ä½“jsonä¾‹ï¼Œ
{
    "clientId": "xxxxxxXXXXXXxxxxxx",
    "subscriptions": [
        "messages/*?options=%7B%22query%22%3A%7B%22expand%22%3A%22author%22%7D%7D"
    ]
}
"messages/*?options=%7B%22query%22%3A%7B%22expand%22%3A%22author%22%7D%7D"
æ­¤å­—ç¬¦ä¸²å»ºè®®é…ç½®è‡³ Config.kt

å®æ—¶äº‹ä»¶æ•°æ®ä¾‹ï¼Œ
Event data format
{
  // æœ¬åº”ç”¨ä¸­ï¼Œåªéœ€ä¹Ÿå¿…é¡»åœ¨æ„createå³å¯
  "action": "create" // create, update or delete,
  "record": 
    {
      "author": "mi4zj55ylb53dgq",
      "collectionId": "pbc_2605467279",
      "collectionName": "messages",
      "content": "å•Šå•Šå•Šå•Š",
      "created": "2026-01-20 10:20:43.791Z",
      "expand": {
        "author": {
          "avatar": "image_thdlw510yb.jpg",
          "bio": "",
          "canSendMessage": "",
          "canUploadFile": "",
          "canUploadImage": "",
          "collectionId": "_pb_users_auth_",
          "collectionName": "users",
          "created": "2026-01-19 14:52:09.679Z",
          "emailVisibility": false,
          "id": "mi4zj55ylb53dgq",
          "isBanned": false,
          "maxUploadFileSize": 0,
          "name": "",
          "updated": "2026-01-19 15:29:58.228Z",
          "username": "aaa",
          "verified": false
        }
      },
      "file": "",
      "id": "grj2ti6s6corv61",
      "images": [],
      "isDeleted": false,
      "replyMessage": "",
      "updated": "2026-01-20 10:20:43.791Z"
    },
}

æˆ‘è§‚å¯Ÿäº†æˆ‘ç°æœ‰çš„ç”¨pocketbaseçš„ç½‘ç«™çš„å®æ—¶çš„å®ç°
å®ƒæ˜¯å…ˆ GET /api/realtime ï¼Œè¿™ä¸ªæ˜¯é•¿è¿æ¥ï¼Œç€è¿™ä¸ªä¸­é©¬ä¸Šå°±ä¼šæœ‰ä¸€ä¸ªäº‹ä»¶ï¼Œæˆ‘åœ¨devtoolä¸­æ­¤è¯·æ±‚çš„EventStreamè§‚å¯Ÿåˆ°å¦‚æ­¤
Type | Data
PB_CONNECT | {"clientId":"hQbH9C6CtW79GIE0VMhFSQdH9rvLJHhGssPZXqHn"}
ç„¶åå®ƒé©¬ä¸Šå°±ä¼šæœ‰ POST /api/realtime ï¼Œä¸”è¯·æ±‚ä½“ä¸­çš„clientIdæ­£æ˜¯clientId
è¿™ä¸ª GET /api/realtime é•¿è¿æ¥ä¼šæŒç»­ä¸¤åˆ†é’Ÿï¼Œæ˜¯å®¢æˆ·ç«¯/æµè§ˆå™¨/å‰ç«¯åˆ»æ„ä¸»åŠ¨æ–­å¼€ï¼Œç„¶ååå°±ä¼šé‡æ–°GETå’ŒPOSTï¼Œå¦‚æ­¤ä¸€ç›´å¾ªç¯

ä¸¤åˆ†é’Ÿ æ­¤å€¼å»ºè®®é…ç½®è‡³ Config.kt

GET /api/realtime æˆ– POST /api/realtime çš„æˆåŠŸä¸å¦ï¼Œä¹Ÿä¼šè®°å½•è‡³StatusStore.setLastStatus

ä½ å…ˆäº†è§£æˆ‘çš„é¡¹ç›®å’Œéœ€æ±‚ï¼Œå…ˆä¸å¿…å®ç°
ä¸å¿…å›å¤
```

```
ç°åœ¨å¼€å§‹å¸®æˆ‘å®ç°ï¼Œ
è®°å¾—è¦ç»™æˆ‘å®Œæ•´çš„æ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹è·¯å¾„å³å¯ï¼Œç”¨/è€Œä¸æ˜¯\ï¼‰
å°æ”¹åŠ¨ç»™æˆ‘å‡†ç¡®æè¿°æ”¹åŠ¨çš„åœ°æ–¹å³å¯
å¤§æ”¹åŠ¨å¾ˆå¤šçš„è¯è¦ç»™æˆ‘å®Œæ•´æ–‡ä»¶
ç»™æˆ‘ä¸€æ¬¡æ€§ç”Ÿæˆå…¨éƒ¨
```

ä½ è®²å¾—éå¸¸æ¸…æ™°ï¼Œæˆ‘ç¡®è®¤æˆ‘å·²ç»**å®Œå…¨ç†è§£ä½ çš„é¡¹ç›®ç°çŠ¶ä¸ SSE éœ€æ±‚**ã€‚æˆ‘ç”¨æœ€ç®€çŸ­ä½†æœºåˆ¶çº§çš„æ–¹å¼å¤è¿°ä¸€éï¼Œç¡®ä¿æˆ‘ä»¬åœ¨åŒä¸€é¢‘é“ã€‚

---

# ä½ ç°åœ¨çš„é¡¹ç›®ï¼ˆæˆ‘å·²åƒé€ï¼‰

- **æ ¸å¿ƒæœºåˆ¶ä»æ˜¯è½®è¯¢**ï¼ˆForegroundService æ¯ 300 ç§’ GET ä¸€æ¬¡ PocketBase messagesï¼‰
- æ”¶åˆ°æ–°æ¶ˆæ¯ â†’ é€šçŸ¥ â†’ å†™å…¥æœ¬åœ° MessageStoreï¼ˆASCï¼‰
- UI é€šè¿‡å¹¿æ’­åˆ·æ–°çŠ¶æ€å›¾æ ‡
- æ‰€æœ‰é…ç½®é›†ä¸­åœ¨ `Config.kt`

è¿™äº›éƒ½ä¿æŒä¸å˜ã€‚

---

# ä½ è¦æ–°å¢çš„åŠŸèƒ½ï¼ˆæˆ‘å·²å®Œå…¨ç†è§£ï¼‰

ä½ è¦åœ¨ç°æœ‰è½®è¯¢åŸºç¡€ä¸Šï¼Œ**æ–°å¢ PocketBase SSE å®æ—¶æ¶ˆæ¯æ”¯æŒ**ï¼Œå½¢æˆä¸‰æ¡å¹¶è¡Œçš„æ•°æ®é€šè·¯ï¼š

---

## **â‘  SSE é•¿è¿æ¥ï¼ˆGET /api/realtimeï¼‰ â†’ Connect**

- è¿™æ˜¯ä¸€ä¸ª **æŒç»­ EventStream**ã€‚
- å»ºç«‹è¿æ¥å PocketBase ä¼šç«‹å³å‘é€ï¼š

```
PB_CONNECT
{"clientId":"xxxx"}
```

- ä½ å¿…é¡»ä»è¿™é‡Œæå– `clientId`ã€‚
- è¿™ä¸ª SSE è¿æ¥ä¼šåœ¨ **çº¦ 2 åˆ†é’Ÿåè¢«å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€**ï¼ˆä½ è§‚å¯Ÿåˆ°çš„è¡Œä¸ºï¼‰ã€‚
- ç„¶åå®¢æˆ·ç«¯å¿…é¡»è‡ªåŠ¨é‡æ–° GET å»ºç«‹æ–°çš„ SSE è¿æ¥ã€‚

ä½ å¸Œæœ›æŠŠï¼š

```
https://uika.top/api/realtime
```

é…ç½®åˆ° `Config.kt`ã€‚

---

## **â‘¡ SSE è®¢é˜…è®¾ç½®ï¼ˆPOST /api/realtimeï¼‰ â†’ Set subscriptions**

- æ¯æ¬¡ GET å»ºç«‹ SSE åï¼Œ**ç«‹å³ POST ä¸€æ¬¡è®¢é˜…**ã€‚
- ä½ å·²ç»æ˜ç¡®ï¼š**ä¸éœ€è¦æ¯åˆ†é’Ÿé‡å¤ POST**ï¼Œåªéœ€åœ¨æ¯æ¬¡æ–°è¿æ¥å POST ä¸€æ¬¡å³å¯ã€‚
- POST è¯·æ±‚ä½“æ ¼å¼ï¼š

```json
{
  "clientId": "xxxxxx",
  "subscriptions": [
    "messages/*?options=%7B%22query%22%3A%7B%22expand%22%3A%22author%22%7D%7D"
  ]
}
```

ä½ å¸Œæœ›æŠŠè®¢é˜…å­—ç¬¦ä¸²ä¹Ÿé…ç½®åˆ° `Config.kt`ã€‚

---

## **â‘¢ è½®è¯¢ï¼ˆGET /api/collections/messages/...ï¼‰ â†’ å…œåº•**

- è½®è¯¢ä»ä¿ç•™ï¼Œç”¨äºï¼š
    - SSE æ–­çº¿æ—¶è¡¥æ¼
    - SSE æ¼äº‹ä»¶æ—¶è¡¥æ¼
    - åå°è¢«ç³»ç»Ÿæ€æ‰æ—¶è¡¥æ¼

é€»è¾‘ä¿æŒä¸å˜ã€‚

---

# SSE äº‹ä»¶æ ¼å¼ï¼ˆä½ åªå…³å¿ƒ createï¼‰

PocketBase ä¼šå‘é€ï¼š

```json
{
  "action": "create",
  "record": { ... }
}
```

ä½ åªå¤„ç† `create`ï¼Œå¹¶å°† `record` è½¬æ¢ä¸º `StoredMessage`ï¼Œä¸è½®è¯¢é€»è¾‘ä¸€è‡´ã€‚

---

# ä½ è§‚å¯Ÿåˆ°çš„æµè§ˆå™¨è¡Œä¸ºï¼ˆæˆ‘å·²å®Œå…¨ç†è§£ï¼‰

ä½ åœ¨ DevTools ä¸­çœ‹åˆ°ï¼š

1. æµè§ˆå™¨å…ˆå‘ GET `/api/realtime`
2. æ”¶åˆ° `PB_CONNECT`ï¼ˆå« clientIdï¼‰
3. æµè§ˆå™¨ç«‹å³å‘ POST `/api/realtime` è®¾ç½®è®¢é˜…
4. SSE è¿æ¥ä¿æŒçº¦ 2 åˆ†é’Ÿ
5. æµè§ˆå™¨ä¸»åŠ¨æ–­å¼€ SSE
6. æµè§ˆå™¨é‡æ–° GET + POST
7. å¾ªç¯å¾€å¤

ä½ å¸Œæœ›åœ¨ Android ä¸­å®Œå…¨å¤åˆ»è¿™ä¸€è¡Œä¸ºã€‚

---

# ğŸ¯ æ€»ç»“ï¼šæˆ‘å·²ç»å®Œå…¨ç†è§£ä½ çš„éœ€æ±‚

- ä½ è¦åœ¨ç°æœ‰è½®è¯¢åŸºç¡€ä¸Šæ–°å¢ SSE å®æ—¶æ¶ˆæ¯æ”¯æŒ
- ä¸‰æ¡é€šè·¯å¹¶è¡Œï¼š  
    **SSE GET â†’ SSE POST â†’ è½®è¯¢ GET**
- SSE äº‹ä»¶ä¼˜å…ˆï¼Œè½®è¯¢å…œåº•
- æ‰€æœ‰é…ç½®é›†ä¸­åˆ° `Config.kt`
- ä¸ç ´åç°æœ‰æ¶æ„

æˆ‘å·²ç»å®Œå…¨ç†è§£ä½ çš„é¡¹ç›®ã€æ¶æ„ã€æœºåˆ¶ã€éœ€æ±‚ã€æœªæ¥æ‰©å±•æ–¹å‘ã€‚

ä½ ä¸‹ä¸€æ­¥æƒ³è®©æˆ‘åšä»€ä¹ˆï¼Œæˆ‘éšæ—¶å‡†å¤‡ç»§ç»­ã€‚