ä½ è¿™æ®µ SSE é€»è¾‘é‡Œï¼Œæœ€å¤§çš„å‘æœ‰ä¸¤ä¸ªï¼š

1. **`source.exhausted()` + `source.readUtf8()` è¿™ä¸€å¥—å¹¶ä¸æ˜¯â€œéé˜»å¡â€ï¼Œè€Œæ˜¯éå¸¸å±é™©çš„ç»„åˆ**
2. **`readUtf8()` ä¼šæŠŠå½“å‰æµé‡Œâ€œèƒ½è¯»åˆ°çš„å…¨éƒ¨å†…å®¹â€ä¸€æ¬¡æ€§è¯»å®Œï¼Œç›´æ¥åƒå…‰ç¼“å†²ï¼Œç”šè‡³ç­‰åˆ°è¿æ¥æ–­å¼€æ‰è¿”å›**

ä¹Ÿå°±æ˜¯è¯´â€”â€”ç°åœ¨è¿™æ®µä»£ç **æ—¢ä¸æ˜¯çœŸæ­£çš„éé˜»å¡**ï¼Œè¿˜å¯èƒ½åœ¨æŸäº›æƒ…å†µä¸‹ï¼š

- å¡åœ¨ `exhausted()` ä¸Šï¼ˆå®ƒå†…éƒ¨ä¼šå°è¯• `request(1)`ï¼Œå¯èƒ½é˜»å¡ï¼‰
- ä¸€æ¬¡æ€§æŠŠæ•´ä¸ª SSE æµè¯»å®Œï¼Œå¯¼è‡´åç»­è§£æé€»è¾‘æ··ä¹±
- é•¿æ—¶é—´æ²¡æœ‰æ•°æ®æ—¶ï¼Œé€»è¾‘å…¶å®æ˜¯â€œé˜»å¡åœ¨åº•å±‚ IO ä¸Š + ä¸Šå±‚åç¨‹æ¯ç§’ delay ç™½ç­‰â€

ä½ çœŸæ­£éœ€è¦çš„ï¼Œå…¶å®æ˜¯ï¼š

- æ¥å—ï¼š**SSE æœ¬è´¨å°±æ˜¯ä¸€ä¸ªé˜»å¡æµ**
- æŠŠâ€œé˜»å¡â€äº¤ç»™ `Dispatchers.IO`ï¼Œè®©çº¿ç¨‹å»é˜»å¡ï¼Œåç¨‹æ¨¡å‹ç…§æ ·æ˜¯å¥åº·çš„
- ç”¨â€œæŒ‰è¡Œè¯»å–â€çš„æ–¹å¼è§£æäº‹ä»¶ï¼ˆ`readUtf8Line()`ï¼‰ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§ `readUtf8()`

ä¸‹é¢æˆ‘ç»™ä½ ä¸€ä¸ª**ä¿®æ­£åçš„ç‰ˆæœ¬**ï¼Œé€»è¾‘ä¿æŒä½ åŸæ¥çš„è¯­ä¹‰ï¼Œä½†æœºåˆ¶æ˜¯æ­£ç¡®çš„ã€å¯é¢„æœŸçš„ã€‚

---

### âœ… ä¿®æ­£åçš„ `connectOnce`

```kotlin
private suspend fun connectOnce() {
    NotificationHelper.sendError(context, "SSE: å¼€å§‹å»ºç«‹è¿æ¥")

    val request = Request.Builder()
        .url(Config.REALTIME_URL)
        .get()
        .build()

    val call = clientForSSE.newCall(request)

    call.execute().use { response ->
        if (!response.isSuccessful) {
            NotificationHelper.sendError(context, "SSE: è¿æ¥å¤±è´¥ HTTP ${response.code}")
            throw IOException("HTTP ${response.code} on realtime connect")
        }

        NotificationHelper.sendError(context, "SSE: è¿æ¥æˆåŠŸï¼Œå¼€å§‹è¯»å–äº‹ä»¶")

        val body = response.body ?: throw IOException("Empty realtime body")
        val source = body.source()

        var currentEvent: String? = null
        var dataBuilder = StringBuilder()
        val startTime = System.currentTimeMillis()

        // æŒ‰è¡Œè¯»å– SSE æµï¼ševent: / data: / ç©ºè¡Œ
        while (
            scope.isActive &&
            System.currentTimeMillis() - startTime <
            Config.REALTIME_SESSION_SECONDS * 1000
        ) {
            // è¿™é‡Œæ˜¯é˜»å¡è¯»å–ï¼Œä½†åœ¨ Dispatchers.IO ä¸Šæ˜¯åˆç†çš„
            val line = try {
                source.readUtf8Line()
            } catch (e: Exception) {
                NotificationHelper.sendError(context, "SSE: è¯»å–å¼‚å¸¸ â†’ ${e.message}")
                break
            } ?: break // null è¡¨ç¤ºæµç»“æŸï¼ˆæœåŠ¡å™¨æ–­å¼€ï¼‰

            val trimmed = line.trimEnd()

            // ç©ºè¡Œ â†’ ä¸€ä¸ªäº‹ä»¶ç»“æŸ
            if (trimmed.isEmpty()) {
                val data = dataBuilder.toString().trim()
                if (data.isNotEmpty()) {
                    NotificationHelper.sendError(context, "SSE: æ”¶åˆ°äº‹ä»¶ â†’ $currentEvent")
                    handleEvent(currentEvent, data)
                }
                currentEvent = null
                dataBuilder = StringBuilder()
                continue
            }

            when {
                trimmed.startsWith("event:") -> {
                    currentEvent = trimmed.removePrefix("event:").trim()
                    NotificationHelper.sendError(context, "SSE: event = $currentEvent")
                }

                trimmed.startsWith("data:") -> {
                    if (dataBuilder.isNotEmpty()) dataBuilder.append('\n')
                    dataBuilder.append(trimmed.removePrefix("data:").trim())
                }
            }
        }

        NotificationHelper.sendError(context, "SSE: ä¼šè¯ç»“æŸï¼ˆæ­£å¸¸æˆ–è¶…æ—¶ï¼‰")
    }
}
```

---

### ğŸ” å…³é”®ä¿®æ­£ç‚¹è¯´æ˜ï¼ˆç®€è¦ç‰ˆï¼‰

- **å»æ‰äº† `exhausted()` + `readUtf8()`**  
    æ”¹ä¸ºæ ‡å‡†çš„ `readUtf8Line()` æŒ‰è¡Œè¯»å–ï¼Œå®Œå…¨è´´åˆ SSE çš„è¡Œåè®®ã€‚
    
- **ä¸å†ä¼ªè£…â€œéé˜»å¡â€**  
    ç›´æ¥æ¥å—â€œè¿™æ˜¯ä¸€ä¸ªé˜»å¡æµâ€ï¼Œä½†å› ä¸ºä½ åœ¨ `Dispatchers.IO` ä¸Šè·‘ï¼Œè¿™ç§é˜»å¡æ˜¯åˆç†çš„ã€å¯æ§çš„ã€‚
    
- **ä¼šè¯æ—¶é•¿ä»ç„¶ç”± `Config.REALTIME_SESSION_SECONDS` æ§åˆ¶**  
    æ¯æ¬¡å¾ªç¯æ£€æŸ¥æ—¶é—´ï¼Œè¶…æ—¶åè‡ªç„¶é€€å‡ºï¼Œå¤–å±‚ `realtimeLoop()` å†å†³å®šæ˜¯å¦é‡è¿ã€‚
    
- **å¼‚å¸¸å¤„ç†æ›´æ¸…æ™°**  
    è¯»å–å¼‚å¸¸ â†’ è®°å½•é€šçŸ¥ â†’ `break` ç»“æŸæœ¬æ¬¡ä¼šè¯ï¼Œç”±ä¸Šå±‚è´Ÿè´£é‡è¿ã€‚
    

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å†å¾€å‰èµ°ä¸€æ­¥ï¼ŒæŠŠï¼š

- å¿ƒè·³ï¼ˆ`comment:` è¡Œï¼‰
- æœåŠ¡å™¨ä¸»åŠ¨æ–­å¼€
- ç½‘ç»œæŠ–åŠ¨é‡è¿ç­–ç•¥

éƒ½è§„èŒƒæˆä¸€ä¸ªâ€œå¯å¤ç”¨çš„ SSE å®¢æˆ·ç«¯åè®®â€ã€‚ä½†å°±ä½ ç°åœ¨è¿™ç‰ˆ App çš„ç›®æ ‡æ¥è¯´ï¼Œä¸Šé¢è¿™æ¬¡ä¿®æ­£å·²ç»æŠŠâ€œæœºåˆ¶çº§é”™è¯¯â€æ¶ˆæ‰äº†ï¼Œè¡Œä¸ºä¼šç¨³å®šå¾ˆå¤šã€‚