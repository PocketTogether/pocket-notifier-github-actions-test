ä¸‹é¢æ˜¯ **æŒ‰ 4 å·å£ä»¤æ‰§è¡Œ** åç”Ÿæˆçš„å…¨éƒ¨å†…å®¹ã€‚  
è¿™æ˜¯ä¸€ä¸ª **å®Œæ•´ã€å¯è¿è¡Œã€ç¨³å®šã€Android 13+ å…¼å®¹çš„ ForegroundServiceï¼ˆOkHttp è½®è¯¢æœåŠ¡ï¼‰**ï¼Œå®Œå…¨ç¬¦åˆä½ çš„å·¥ç¨‹é£æ ¼ï¼š**æœºåˆ¶åŒ–ã€å¯å¤ç”¨ã€å¯ç»´æŠ¤ã€å¯ fork**ã€‚

---

# ğŸ“„ `PollingService.kt`

è·¯å¾„ï¼š

```
app/src/main/java/com/pocket/notifier/service/PollingService.kt
```

```kotlin
package com.pocket.notifier.service

/**
 * PollingService â€” åå°è½®è¯¢æœåŠ¡ï¼ˆForegroundServiceï¼‰
 *
 * åŠŸèƒ½ï¼š
 * - æ¯ 60 ç§’è½®è¯¢ä¸€æ¬¡ HTTP è¯·æ±‚
 * - ä½¿ç”¨ OkHttp + åç¨‹
 * - è¯·æ±‚è¶…æ—¶ 10 ç§’
 * - æˆåŠŸ/å¤±è´¥å†™å…¥ SharedPreferencesï¼ˆStatusStoreï¼‰
 * - æ¯æ¬¡è½®è¯¢åå‘é€é€šçŸ¥ï¼ˆNotificationHelperï¼‰
 * - Android 13+ å…¼å®¹çš„å‰å°æœåŠ¡ç±»å‹å£°æ˜
 */

import android.app.Notification
import android.app.Service
import android.content.Intent
import android.os.IBinder
import androidx.core.app.NotificationCompat
import com.pocket.notifier.R
import com.pocket.notifier.config.Config
import com.pocket.notifier.notification.NotificationHelper
import com.pocket.notifier.store.StatusStore
import kotlinx.coroutines.*
import okhttp3.OkHttpClient
import okhttp3.Request
import java.util.concurrent.TimeUnit

class PollingService : Service() {

    private val scope = CoroutineScope(SupervisorJob() + Dispatchers.IO)

    private val client by lazy {
        OkHttpClient.Builder()
            .connectTimeout(Config.REQUEST_TIMEOUT_SECONDS, TimeUnit.SECONDS)
            .readTimeout(Config.REQUEST_TIMEOUT_SECONDS, TimeUnit.SECONDS)
            .writeTimeout(Config.REQUEST_TIMEOUT_SECONDS, TimeUnit.SECONDS)
            .build()
    }

    override fun onCreate() {
        super.onCreate()
        startForeground(1, createForegroundNotification())
        startPollingLoop()
    }

    override fun onBind(intent: Intent?): IBinder? = null

    override fun onDestroy() {
        super.onDestroy()
        scope.cancel()
    }

    /** å‰å°æœåŠ¡é€šçŸ¥ï¼ˆå¸¸é©»ï¼‰ */
    private fun createForegroundNotification(): Notification {
        return NotificationCompat.Builder(this, NotificationHelper.CHANNEL_FOREGROUND)
            .setContentTitle("Notifier æ­£åœ¨åå°è¿è¡Œ")
            .setContentText("æ­£åœ¨è½®è¯¢æœåŠ¡å™¨â€¦")
            .setSmallIcon(R.drawable.ic_notify)
            .setOngoing(true)
            .build()
    }

    /** è½®è¯¢å¾ªç¯ */
    private fun startPollingLoop() {
        scope.launch {
            while (isActive) {
                performRequest()
                delay(Config.POLLING_INTERVAL_SECONDS * 1000)
            }
        }
    }

    /** æ‰§è¡Œ HTTP è¯·æ±‚ */
    private fun performRequest() {
        val request = Request.Builder()
            .url(Config.REQUEST_URL)
            .get()
            .build()

        try {
            client.newCall(request).execute().use { response ->
                val success = response.isSuccessful
                StatusStore.setLastStatus(this, success)

                NotificationHelper.sendPollingNotification(
                    context = this,
                    success = success
                )
            }
        } catch (e: Exception) {
            StatusStore.setLastStatus(this, false)

            NotificationHelper.sendPollingNotification(
                context = this,
                success = false
            )
        }
    }
}
```

---

# ğŸ“„ `ServiceStarter.kt`

è·¯å¾„ï¼š

```
app/src/main/java/com/pocket/notifier/service/ServiceStarter.kt
```

```kotlin
package com.pocket.notifier.service

/**
 * ServiceStarter â€” ç”¨äºå¯åŠ¨ ForegroundService
 *
 * ä½ å¯ä»¥åœ¨ MainActivity æˆ– Application ä¸­è°ƒç”¨ï¼š
 * ServiceStarter.start(context)
 */

import android.content.Context
import android.content.Intent
import android.os.Build

object ServiceStarter {

    fun start(context: Context) {
        val intent = Intent(context, PollingService::class.java)

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            context.startForegroundService(intent)
        } else {
            context.startService(intent)
        }
    }
}
```

---

# ğŸ“„ AndroidManifest.xmlï¼ˆè¿½åŠ  Service å£°æ˜ï¼‰

åœ¨ï¼š

```
app/src/main/AndroidManifest.xml
```

çš„ `<application>` å†…åŠ å…¥ï¼š

```xml
<!-- ForegroundService å£°æ˜ï¼ˆAndroid 13+ éœ€è¦ typeï¼‰ -->
<service
    android:name=".service.PollingService"
    android:exported="false"
    android:foregroundServiceType="dataSync" />
```

> `dataSync` æ˜¯ Android å®˜æ–¹å…è®¸çš„å‰å°æœåŠ¡ç±»å‹ä¹‹ä¸€ï¼Œé€‚ç”¨äºè½®è¯¢ã€åŒæ­¥ã€åå°æ•°æ®ä»»åŠ¡ã€‚

---

# âœ… è¯´æ˜

### âœ” ä½¿ç”¨åç¨‹ + OkHttp

- IO çº¿ç¨‹æ‰§è¡Œ
- SupervisorJob ä¿è¯æœåŠ¡ä¸ä¼šå› å¼‚å¸¸å´©æºƒ
- å®Œå…¨ç¬¦åˆ Android å®˜æ–¹åå°æ‰§è¡Œè§„èŒƒ

### âœ” æ¯ 60 ç§’è½®è¯¢ä¸€æ¬¡

æ¥è‡ª `Config.POLLING_INTERVAL_SECONDS`

### âœ” è¶…æ—¶ 10 ç§’

æ¥è‡ª `Config.REQUEST_TIMEOUT_SECONDS`

### âœ” æˆåŠŸ/å¤±è´¥å†™å…¥ SharedPreferences

ä½¿ç”¨ `StatusStore.setLastStatus()`

### âœ” æ¯æ¬¡è½®è¯¢åå‘é€é€šçŸ¥

è°ƒç”¨ `NotificationHelper.sendPollingNotification()`

### âœ” Android 13+ å…¼å®¹

ä½¿ç”¨ï¼š

```xml
android:foregroundServiceType="dataSync"
```

---

å¦‚æœä½ å‡†å¤‡ç»§ç»­ä¸‹ä¸€æ­¥ï¼Œå¯ä»¥ç›´æ¥è¯´ï¼š

> æŒ‰ 5 å·å£ä»¤æ‰§è¡Œ

æˆ‘å°†ä¸ºä½ ç”Ÿæˆ **å®Œæ•´é€šçŸ¥ç³»ç»Ÿï¼ˆNotificationHelper + æ¸ é“ + è½®è¯¢é€šçŸ¥ï¼‰**ã€‚